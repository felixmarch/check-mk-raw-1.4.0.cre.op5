function getElementsByClass(cl){var items=new Array();var elements=document.getElementsByTagName('*');for(var i=0;i<elements.length;i++)if(elements[i].className==cl)items.push(elements[i]);return items;}function wato_check_all(css_class){var items=getElementsByClass(css_class);var all_checked=true;for(var i=0;i<items.length&&all_checked==true;i++)if(items[i].checked==false)all_checked=false;for(var i=0;i<items.length;i++)items[i].checked=!all_checked;}function wato_toggle_attribute(oCheckbox,attrname){var oEntry=document.getElementById("attr_entry_"+attrname);var oDefault=document.getElementById("attr_default_"+attrname);if(!oEntry)return;if(oCheckbox.checked){oEntry.style.display="";oDefault.style.display="none";}else{oEntry.style.display="none";oDefault.style.display="";}}function wato_fix_visibility(){var currentTags=[];var oHostTags=document.getElementById("wato_host_tags");if(!oHostTags)return;var oTable=oHostTags.childNodes[0];for(var i=0;i<oTable.childNodes.length;i++){var oTr=oTable.childNodes[i];if(oTr.tagName=='TR'){var oTdLegend=oTr.childNodes[0];if(oTdLegend.className!="legend")continue;var oTdContent=oTr.childNodes[1];var oCheckbox=oTdLegend.getElementsByTagName("input")[0];if(oCheckbox.checked==false){var attrname='attr_'+oCheckbox.name.replace(/.*_change_/,'');if(attrname in inherited_tags&&inherited_tags[attrname]!==null)currentTags=currentTags.concat(inherited_tags[attrname].split("|"));}else{var oElement=oTdContent.childNodes[0].childNodes[0];if(oElement.type=='checkbox'&&oElement.checked)currentTags=currentTags.concat(oElement.getAttribute('tags').split("|"));else if(oElement.tagName=='SELECT')currentTags=currentTags.concat(oElement.value.split("|"));}}}var hide_topics=volatile_topics.slice(0);for(var i=0;i<wato_check_attributes.length;i++){var attrname=wato_check_attributes[i];var display="";if(hide_attributes.indexOf(attrname)>-1)display="none";if(display==""&&attrname in wato_depends_on_roles)for(var index=0;index<wato_depends_on_roles[attrname].length;index++){var role=wato_depends_on_roles[attrname][index];var negate=role[0]=='!';var rolename=negate?role.substr(1):role;var have_role=user_roles.indexOf(rolename)!=-1;if(have_role==negate){display="none";break;}}if(display==""&&attrname in wato_depends_on_tags)for(var index=0;index<wato_depends_on_tags[attrname].length;index++){var tag=wato_depends_on_tags[attrname][index];var negate=tag[0]=='!';var tagname=negate?tag.substr(1):tag;var have_tag=currentTags.indexOf(tagname)!=-1;if(have_tag==negate){display="none";break;}}var oTr=document.getElementById("attr_"+attrname);if(oTr){oTr.style.display=display;var oAttrDisp=document.getElementById("attr_display_"+attrname);if(!oAttrDisp){var oAttrDisp=document.createElement("input");oAttrDisp.name="attr_display_"+attrname;oAttrDisp.id="attr_display_"+attrname;oAttrDisp.type="hidden";oAttrDisp.className="text";oTr.appendChild(oAttrDisp);}if(display=="none"){var chkbox=oAttrDisp.parentNode.childNodes[0].childNodes[1].childNodes[0];chkbox.checked=false;wato_toggle_attribute(chkbox,attrname);oAttrDisp.value="0";}else oAttrDisp.value="1";var topic=oTr.parentNode.childNodes[0].textContent;if(display==""){var index=hide_topics.indexOf(topic);if(index!=-1)delete hide_topics[index];}}}var available_forms=["form_edit_host","form_editfolder"];for(var try_form=0;try_form<available_forms.length;try_form++){var my_form=document.getElementById(available_forms[try_form]);if(my_form!=null){for(var child in my_form.childNodes){oTr=my_form.childNodes[child];if(oTr.className=="nform")if(hide_topics.indexOf(oTr.childNodes[0].childNodes[0].textContent)>-1)oTr.style.display="none";else oTr.style.display="";}break;}}}function wato_randomize_secret(id,len){var secret="";for(var i=0;i<len;i++){var c=parseInt(26*Math.random()+64);secret+=String.fromCharCode(c);}var oInput=document.getElementById(id);oInput.value=secret;}var progress_mode=null;var progress_url=null;var progress_timeout=null;var progress_items=null;var failed_items=null;var progress_total_num=0;var progress_found=0;var progress_success_stats=[];var progress_fail_stats=[];var progress_end_url='';var progress_term_url='';var progress_fin_txt='';var progress_running=false;var progress_paused=false;var progress_ended=false;function progress_handle_error(data,code,msg){progress_handle_response(data,'',code);}function progress_handle_response(data,code,http_code){var mode=data[0];var item=data[1];var header=null;var body=null;if(http_code!==undefined){var parts=data[1].split("|");var last_part=parts[parts.length-1];var items=last_part.split(";");var num_failed=items.length;header=['failed',num_failed];for(var i=1;i<=Math.max.apply(Math,progress_fail_stats);i++)if(progress_fail_stats.indexOf(i)!==-1)header.push(num_failed);else header.push(0);body='';for(var i=0;i<items.length;i++)body+=items[i]+' failed: HTTP-Request failed with code '+http_code+'<br>';}else{try{var header=eval(code.split("\n",1)[0]);if(header===null)alert('Header is null!');}catch(err){alert('Invalid response: '+code);}var body=code.split('\n');body.splice(0,1);body=body.join('');}update_progress_stats(header);update_progress_bar(header);if(typeof body!=='undefined'&&body!='')progress_attach_log(body);if(header[0]==='pause')progress_pause();else if(header[0]=='failed')failed_items.push(item);else if(header[0]==='abort')return;progress_items.shift();progress_running=false;}function progress_pause(){progress_paused=true;document.getElementById('progress_pause').style.display='none';document.getElementById('progress_proceed').style.display='';}function progress_proceed(){progress_paused=false;document.getElementById('progress_pause').style.display='';document.getElementById('progress_proceed').style.display='none';}function progress_retry(){document.getElementById('progress_retry').style.display='none';document.getElementById('progress_pause').style.display='';document.getElementById('progress_abort').style.display='';progress_clean_log();clear_progress_stats();progress_items=failed_items;failed_items=Array();progress_scheduler(progress_mode,progress_url,progress_timeout,[],"","");}function progress_finished(){update_progress_title(progress_fin_txt);document.getElementById('progress_bar').className='finished';document.getElementById('progress_finished').style.display='';document.getElementById('progress_pause').style.display='none';document.getElementById('progress_proceed').style.display='none';document.getElementById('progress_abort').style.display='none';if(failed_items.length>0)document.getElementById('progress_retry').style.display='';}function progress_end(){progress_ended=true;if(progress_found>0)location.href=progress_end_url;else location.href=progress_term_url;}function clear_progress_stats(){progress_found=0;for(var i=1;i<100;i++){var o=document.getElementById('progress_stat'+(i-1));if(o)o.innerHTML="0";else break;}}function update_progress_stats(header){for(var i=1;i<header.length;i++){var o=document.getElementById('progress_stat'+(i-1));if(o){for(var a=0;a<progress_success_stats.length;a++)if(progress_success_stats[a]==i)progress_found+=parseInt(header[i]);o.innerHTML=parseInt(o.innerHTML)+parseInt(header[i]);}}}function update_progress_bar(header){var num_done=progress_total_num-progress_items.length+1;var perc_done=num_done/progress_total_num*100;var bar=document.getElementById('progress_bar');var cell=bar.firstChild.firstChild.firstChild;cell.style.width=perc_done+"%";cell=bar.firstChild.firstChild.childNodes[1];cell.style.width=(100-perc_done)+"%";return false;}function update_progress_title(t){document.getElementById('progress_title').innerHTML=t;}function progress_attach_log(t){var log=document.getElementById('progress_log');log.innerHTML+=t;log.scrollTop=log.scrollHeight;}function progress_clean_log(){var log=document.getElementById('progress_log');log.innerHTML='';log.scrollTop=0;}function progress_scheduler(mode,url_prefix,timeout,items,transids,end_url,success_stats,fail_stats,term_url,finished_txt){if(progress_items===null){total_num_items=items.length;progress_items=items;failed_items=Array();progress_transids=transids;progress_total_num=items.length;progress_end_url=end_url;progress_term_url=term_url;progress_success_stats=success_stats;progress_fail_stats=fail_stats;progress_fin_txt=finished_txt;progress_mode=mode;progress_url=url_prefix;progress_timeout=timeout;}if(progress_ended)return false;if(!progress_paused&&!progress_running)if(progress_items.length>0){num_items_left=progress_items.length;perc=Math.round(100-(100.0*num_items_left/total_num_items));title=perc+"%";progress_running=true;update_progress_title(title);use_transid=progress_transids.shift();get_url(url_prefix+'&_transid='+use_transid+'&_item='+encodeURIComponent(progress_items[0]),progress_handle_response,[mode,progress_items[0]],progress_handle_error);}else{progress_finished();return;}setTimeout(function(){progress_scheduler(mode,url_prefix,timeout,[],"","");},timeout);}function update_bulk_moveto(val){var fields=getElementsByClass('bulk_moveto');for(var i=0;i<fields.length;i++)for(var a=0;a<fields[i].options.length;a++)if(fields[i].options[a].value==val)fields[i].options[a].selected=true;}function activate_changes(mode,site_id){var sites=[];if(mode=="selected"){var checkboxes=document.getElementsByClassName("site_checkbox");for(var i=0;i<checkboxes.length;i++)if(checkboxes[i].checked)sites.push(checkboxes[i].name.substr(5));if(sites.length==0){show_activation_error("You have to select a site.");return;}}else if(mode=="site")sites.push(site_id);var activate_until=document.getElementById("activate_until");if(!activate_until)return;var comment="";var comment_field=document.getElementsByName("activate_p_comment")[0];if(comment_field.value!="")comment=comment_field.value;var activate_foreign=0;var foreign_checkbox=document.getElementsByName("activate_p_foreign")[0];if(foreign_checkbox&&foreign_checkbox.checked)activate_foreign=1;start_activation(sites,activate_until.value,comment,activate_foreign);}function start_activation(sites,activate_until,comment,activate_foreign){show_activation_info("Initializing activation...");var post_data="activate_until="+encodeURIComponent(activate_until)+"&sites="+encodeURIComponent(sites.join(","))+"&comment="+encodeURIComponent(comment)+"&activate_foreign="+encodeURIComponent(activate_foreign);call_ajax("ajax_start_activation.py",{response_handler:handle_start_activation,error_handler:handle_start_activation_error,method:"POST",post_data:post_data,add_ajax_id:false});lock_activation_controls(true);hide_last_results();show_details(false);}function handle_start_activation(_unused,response_json){var response=JSON.parse(response_json);if(response.result_code==1){show_activation_error(response.result);lock_activation_controls(false);}else monitor_activation_progress(response.result.activation_id);}function handle_start_activation_error(_unused,status_code,error_msg){show_activation_error("Failed to start activation ["+status_code+"]: "+error_msg);finish_activation();}function show_activation_error(text){var container=document.getElementById("activation_msg");container.style.display="block";var msg=container.childNodes[0];add_class(msg,"error");remove_class(msg,"success");msg.innerHTML=text;}function show_activation_info(text){var container=document.getElementById("activation_msg");container.style.display="block";var msg=container.childNodes[0];add_class(msg,"success");remove_class(msg,"error");msg.innerHTML=text;}function hide_activation_message(){var msg=document.getElementById("activation_msg");if(msg)msg.style.display="none";}function lock_activation_controls(lock){var elements=[];elements.push(document.getElementById("activate_affected"));elements.push(document.getElementById("activate_selected"));elements.push(document.getElementById("discard_changes_button"));elements=elements.concat(Array.prototype.slice.call(document.getElementsByName("activate_p_comment"),0));elements=elements.concat(Array.prototype.slice.call(document.getElementsByClassName("site_checkbox"),0));elements=elements.concat(Array.prototype.slice.call(document.getElementsByClassName("activate_site"),0));for(var i=0;i<elements.length;i++){if(!elements[i])continue;if(lock)add_class(elements[i],"disabled");else remove_class(elements[i],"disabled");elements[i].disabled=lock?"disabled":false;}}function hide_last_results(){var elements=[];elements=elements.concat(Array.prototype.slice.call(document.getElementsByClassName("last_result"),0));elements=elements.concat(Array.prototype.slice.call(document.getElementsByClassName("header_last_result"),0));for(var i=0;i<elements.length;i++)elements[i].style.display="none";}function show_details(show){var elements=[];elements=elements.concat(Array.prototype.slice.call(document.getElementsByClassName("details"),0));elements=elements.concat(Array.prototype.slice.call(document.getElementsByClassName("header_details"),0));for(var i=0;i<elements.length;i++)elements[i].style.display=show?"table-cell":"none";}function show_progress(show){var elements=[];elements=elements.concat(Array.prototype.slice.call(document.getElementsByClassName("repprogress"),0));elements=elements.concat(Array.prototype.slice.call(document.getElementsByClassName("header_repprogress"),0));for(var i=0;i<elements.length;i++)elements[i].style.display=show?"table-cell":"none";}function monitor_activation_progress(activation_id){show_activation_info("Activating...");call_ajax("ajax_activation_state.py?activation_id="+encodeURIComponent(activation_id),{response_handler:handle_activation_progress,error_handler:handle_activation_progress_error,handler_data:activation_id,method:"GET",add_ajax_id:false});}function handle_activation_progress(activation_id,response_json){var response=JSON.parse(response_json);if(response.result_code==1){show_activation_error(response.result);return;}else{update_activation_state(response.result);if(!activation_progress_finished(response.result))setTimeout(function(){return monitor_activation_progress(activation_id);},500);else finish_activation();}}function activation_progress_finished(response){for(var site_id in response.sites){if(!response.sites.hasOwnProperty(site_id))continue;var site_state=response.sites[site_id];if(site_state._phase!="done")return false;}return true;}function update_activation_state(response){for(var site_id in response.sites){if(!response.sites.hasOwnProperty(site_id))continue;var site_state=response.sites[site_id];var is_empty=true;for(var prop in site_state)if(site_state.hasOwnProperty(prop)){is_empty=false;break;}if(is_empty)throw "Empty site state for "+site_id;update_site_activation_state(site_state);}}function update_site_activation_state(site_state){var msg=document.getElementById("site_"+site_state._site_id+"_status");msg.innerHTML=site_state._status_text;if(site_state._status_details){show_details(true);var msg=document.getElementById("site_"+site_state._site_id+"_details");msg.innerHTML=site_state._status_details;}update_site_progress(site_state);}function update_site_progress(site_state){var max_width=160;var progress=document.getElementById("site_"+site_state._site_id+"_progress");show_progress(true);if(site_state._phase=="done"){progress.style.width=max_width+"px";add_class(progress,"state_"+site_state._state);return;}var duration=parseFloat(time()-site_state._time_started);var expected_duration=site_state._expected_duration;var duration_percent=duration*100.0/expected_duration;var width=parseInt(parseFloat(max_width)*duration_percent/100);if(width>max_width)width=max_width;progress.style.width=width+"px";}function handle_activation_progress_error(activation_id,status_code,error_msg){show_activation_error("Failed to fetch activation state ["+status_code+"]: "+error_msg+". "+"Retrying in 1 second.");setTimeout(function(){return monitor_activation_progress(activation_id);},1000);}function finish_activation(){show_activation_info("Activation has finished. Reloading in 1 second.");lock_activation_controls(false);schedule_reload('',1000);reload_sidebar();}var profile_replication_progress=new Array();function wato_do_profile_replication(siteid,est,progress_text){get_url("wato_ajax_profile_repl.py?site="+siteid,wato_profile_replication_result,siteid);profile_replication_progress[siteid]=20;setTimeout("profile_replication_step('"+siteid+"', "+est+", '"+progress_text+"');",est/20);}function profile_replication_set_status(siteid,image,text){var oImg=document.getElementById("site-"+siteid).childNodes[0];oImg.title=text;oImg.src='images/icon_'+image+'.png';}function profile_replication_step(siteid,est,progress_text){if(profile_replication_progress[siteid]>0){profile_replication_progress[siteid]--;var perc=(20.0-profile_replication_progress[siteid])*100/20;var img;if(perc>=75)img='repl_75';else if(perc>=50)img='repl_50';else if(perc>=25)img='repl_25';else img='repl_pending';profile_replication_set_status(siteid,img,progress_text);setTimeout("profile_replication_step('"+siteid+"',"+est+", '"+progress_text+"');",est/20);}}function wato_profile_replication_result(siteid,code){profile_replication_progress[siteid]=0;var oDiv=document.getElementById("site-"+siteid);if(code[0]=="0")profile_replication_set_status(siteid,'repl_success',code.substr(2));else profile_replication_set_status(siteid,'repl_failed',code.substr(2));g_num_replsites--;if(0==g_num_replsites)setTimeout(wato_profile_replication_finish,1000);}function wato_profile_replication_finish(){if(this.parent&&parent&&parent.frames[1]==this)reload_sidebar();}function wato_open_folder(event,link){if(!event)event=window.event;var target=getTarget(event);if(target.tagName!='DIV')return false;location.href=link;}function wato_toggle_folder(event,oDiv,on){if(!event)event=window.event;if(!on){var node=event.toElement||event.relatedTarget;while(node){if(node==oDiv)return false;node=node.parentNode;}}var obj=oDiv.parentNode;var id=obj.id.substr(7);var elements=['edit','popup_trigger_move','delete'];for(var num in elements){var elem=document.getElementById(elements[num]+'_'+id);if(elem)if(on)elem.style.display='inline';else elem.style.display='none';}if(on)add_class(obj,"open");else{remove_class(obj,"open");var move_dialog=document.getElementById('move_dialog_'+id);if(move_dialog)move_dialog.style.display='none';}}function handle_host_diag_result(ident,response_text){var img=document.getElementById(ident+'_img');var log=document.getElementById(ident+'_log');var retry=document.getElementById(ident+'_retry');remove_class(img,"reloading");if(response_text[0]=="0"){img.src="images/icon_success.png";log.className="log diag_success";}else{img.src="images/icon_failed.png";log.className="log diag_failed";}log.innerHTML=response_text.substr(1).replace(/\n/g,"<br>\n");retry.src="images/icon_reload.png";retry.style.display='inline';}function start_host_diag_test(ident,hostname){var log=document.getElementById(ident+'_log');var img=document.getElementById(ident+'_img');var retry=document.getElementById(ident+'_retry');retry.style.display='none';var vars='';vars='&ipaddress='+encodeURIComponent(document.getElementsByName('vs_host_p_ipaddress')[0].value);if(document.getElementsByName("vs_host_p_snmp_community_USE")[0].checked)vars+='&snmp_community='+encodeURIComponent(document.getElementsByName('vs_host_p_snmp_community')[0].value);if(document.getElementsByName("vs_host_p_snmp_v3_credentials_USE")[0].checked){v3_use=encodeURIComponent(document.getElementsByName('vs_host_p_snmp_v3_credentials_use')[0].value);vars+='&snmpv3_use='+v3_use;if(v3_use=="0")vars+='&snmpv3_security_name='+encodeURIComponent(document.getElementsByName('vs_host_p_snmp_v3_credentials_0_1')[0].value);else if(v3_use=="1"){vars+='&snmpv3_auth_proto='+encodeURIComponent(document.getElementsByName('vs_host_p_snmp_v3_credentials_1_1')[0].value);vars+='&snmpv3_security_name='+encodeURIComponent(document.getElementsByName('vs_host_p_snmp_v3_credentials_1_2')[0].value);vars+='&snmpv3_security_password='+encodeURIComponent(document.getElementsByName('vs_host_p_snmp_v3_credentials_1_3')[0].value);}else if(v3_use=="2"){vars+='&snmpv3_auth_proto='+encodeURIComponent(document.getElementsByName('vs_host_p_snmp_v3_credentials_2_1')[0].value);vars+='&snmpv3_security_name='+encodeURIComponent(document.getElementsByName('vs_host_p_snmp_v3_credentials_2_2')[0].value);vars+='&snmpv3_security_password='+encodeURIComponent(document.getElementsByName('vs_host_p_snmp_v3_credentials_2_3')[0].value);vars+='&snmpv3_privacy_proto='+encodeURIComponent(document.getElementsByName('vs_host_p_snmp_v3_credentials_2_4')[0].value);vars+='&snmpv3_privacy_password='+encodeURIComponent(document.getElementsByName('vs_host_p_snmp_v3_credentials_2_5')[0].value);}}vars+='&agent_port='+encodeURIComponent(document.getElementsByName('vs_rules_p_agent_port')[0].value);vars+='&snmp_timeout='+encodeURIComponent(document.getElementsByName('vs_rules_p_snmp_timeout')[0].value);vars+='&snmp_retries='+encodeURIComponent(document.getElementsByName('vs_rules_p_snmp_retries')[0].value);vars+='&datasource_program='+encodeURIComponent(document.getElementsByName('vs_rules_p_datasource_program')[0].value);img.src="images/icon_reload.png";add_class(img,"reloading");log.innerHTML="...";get_url("wato_ajax_diag_host.py?host="+encodeURIComponent(hostname)+"&_test="+encodeURIComponent(ident)+vars,handle_host_diag_result,ident);}function execute_active_check(site,hostname,checktype,item,divid){var oDiv=document.getElementById(divid);var url="wato_ajax_execute_check.py?"+"site="+encodeURIComponent(site)+"&host="+encodeURIComponent(hostname)+"&checktype="+encodeURIComponent(checktype)+"&item="+encodeURIComponent(item);get_url(url,handle_execute_active_check,oDiv);}function handle_execute_active_check(oDiv,response_json){var response=JSON.parse(response_json);if(response.result_code==1){var state=3;var statename="UNKN";var output=response.result;}else{var state=response.result.state;if(state==-1)state="p";var statename=response.result.state_name;var output=response.result.output;}oDiv.innerHTML=output;var oTr=oDiv.parentNode.parentNode;if(has_class(oTr,"even0"))add_class(oTr,"even"+state);else add_class(oTr,"odd"+state);var oTdState=oTr.getElementsByClassName("state")[0];remove_class(oTdState,"statep");add_class(oTdState,"state"+state);oTdState.innerHTML=statename;}